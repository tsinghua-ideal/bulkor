A more secure version, without PRF optimization
